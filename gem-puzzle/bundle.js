(()=>{"use strict";function e(e){let t=0;for(let s=0;s<e.length-1;s+=1)e[s]!==s+1&&(t+=1);return 0!==e[e.length-1]&&(t+=1),t}function t(e){const t=[];let s=[];const i=e.indexOf(0);return function(e){const{length:t}=e,s=Math.sqrt(t),i=e.indexOf(0),l=[],n=i-s;n>=0&&l.push(n);const a=i+s;a<=t-1&&l.push(a);const o=i-1;(i+1)%s!=1&&l.push(o);const r=i+1;return(i+1)%s!=0&&l.push(r),l}(e).forEach((l=>{const[...n]=[...e];s.push(i),s.push(l),s.push(function(e,t,s){const i=e[t],l=e[s];return e.splice(t,1,l),e.splice(s,1,i),e}(n,l,i)),t.push(s),s=[]})),t}function s(e,t){if(e.length!==t.length)return!1;let s=0;for(let i=0;i<e.length;i+=1)e[i]!==t[i]&&(s+=1);return 0===s}const i=1e3;function l(e){let t=[];return[...t]=[...e],t=t.sort((()=>Math.random()-.5)),t}function n(e,t){let s=0;const i=e.length;for(let t=0;t<i;t+=1){let l=0;for(let s=0;s<i;s+=1)t<s&&e[t]>e[s]&&0!==e[s]&&(l+=1);s+=l}return t%2==0&&(s+=Math.ceil((e.indexOf(0)+1)/t)),s%2==0}function a(e){return(parseInt(e,10)<10?"0":"")+e}(new class{constructor(){this.elements={randomArray:[],main:null,puzzle:null,tiles:[],savedTiles:null,emptyTile:{top:null,left:null,position:null},savedEmptyTile:null,counter:{counter:{},timer:{},moves:{}},menu:{menu:null,newGame:null,newGamePic:null,newGameSize:null,table:null,finish:null,volume:null,hideDig:null},modal:{modal:null,text:null,ok:null,newGame:null},table:{modal:null,table:null,ok:null},audio:null},this.parameters={puzzleSize:4,puzzleBoxSize:400,tileSize:null,isNewGame:!0,isEndGame:!1,retoredGame:!1,drag:{X:null,Y:null},volume:!1},this.counter={moves:0,time:0,startTime:null,endTime:null,timeoutID:null},this.results={date:null,puzzleSize:null,time:null,moves:null},this.picture={link:null,isPicture:!1,digits:!0}}init(e=4){const t=document.querySelector(".body");this.elements.main=document.createElement("div"),this.elements.main.classList.add("main"),this.elements.puzzle=document.createElement("div"),this.elements.puzzle.classList.add("puzzle"),t.append(this.elements.main),null!=localStorage.moves&&(this.counter.moves=+localStorage.moves),this.createCounter(),this.elements.main.append(this.elements.puzzle),this.setPuzzleSize(e),null==localStorage.puzzle?(this.createTiles(),this.placeTiles(),this.saveGame()):(this.getSavedGame(),this.reCreateAndPlaceTiles()),this.createMenu(),this.createModal(),this.createTable()}setPuzzleSize(e){null!=localStorage.puzzleSize&&0!==localStorage.puzzleSize?this.parameters.puzzleSize=localStorage.puzzleSize:this.parameters.puzzleSize=e<3?3:e>8?8:e}createTiles(){this.elements.randomArray=this.createArr(),this.elements.randomArray.forEach((e=>{const t=document.createElement("div");t.classList.add("tile",`tilesize${this.parameters.puzzleSize}`),t.setAttribute("draggable","true"),t.innerHTML=e,t.numValue=e,t.left=0,t.top=0,0===e&&(t.style.display="none",t.empty=!0),this.elements.tiles.push(t)}))}placeTiles(){this.parameters.tileSize=Math.floor(this.parameters.puzzleBoxSize/this.parameters.puzzleSize),this.elements.tiles.forEach(((e,t)=>{const s=e;s.top=Math.floor(t/this.parameters.puzzleSize)*this.parameters.tileSize,s.left=Math.floor(t%this.parameters.puzzleSize)*this.parameters.tileSize,s.position=t+1,s.key=t,s.style.left=`${s.left}px`,s.style.top=`${s.top}px`,s.empty&&(this.elements.emptyTile.top=s.top,this.elements.emptyTile.left=s.left,this.elements.emptyTile.position=t+1,s.position=0),this.addListeners(s,t),this.elements.puzzle.append(s)}))}reCreateAndPlaceTiles(){this.elements.savedTiles.forEach((e=>{const t=document.createElement("div");t.classList.add("tile",`tilesize${this.parameters.puzzleSize}`),t.setAttribute("draggable","true"),t.innerHTML=e.numValue,t.numValue=e.numValue,t.left=e.left,t.top=e.top,t.position=e.position,t.key=e.key,0===e.numValue&&(t.style.display="none",t.empty=!0,this.elements.emptyTile.top=this.elements.savedEmptyTile.top,this.elements.emptyTile.left=this.elements.savedEmptyTile.left,this.elements.emptyTile.position=this.elements.savedEmptyTile.position),this.elements.tiles.push(t)})),this.parameters.tileSize=Math.floor(this.parameters.puzzleBoxSize/this.parameters.puzzleSize),this.elements.tiles.forEach((e=>{const t=e;t.style.left=`${t.left}px`,t.style.top=`${t.top}px`,this.addListeners(t,t.key),this.elements.puzzle.append(t)})),this.picture.isPicture&&this.addPicture()}addListeners(e,t){e.addEventListener("click",(()=>{this.moveTile(t)})),e.addEventListener("dragstart",(e=>{this.dragStart(e)})),e.addEventListener("dragend",(e=>{this.dragEnd(e)}))}addPicture(){this.parameters.isNewGame&&(this.picture.link=`assets/img/box/${Math.ceil(Math.random()*i)%150}.jpg`),this.elements.tiles.forEach((e=>{const t=e;t.classList.add("picDigits"),t.style.background=`url("${this.picture.link}")`,t.style.backgroundSize=100*this.parameters.puzzleSize+"%";const s=-100*(t.numValue%this.parameters.puzzleSize-1),i=-100*Math.floor((t.numValue-1)/this.parameters.puzzleSize);t.style.backgroundPosition=`${s}% ${i}%`}))}moveTile(e){let t=e;0===this.elements.tiles[t].numValue&&this.elements.tiles.forEach(((e,s)=>{t===e.position-1&&(t=s)}));const s=this.elements.tiles[t].left,i=this.elements.tiles[t].top,l=this.elements.tiles[t].position;Math.floor(Math.abs(s-this.elements.emptyTile.left)+Math.abs(i-this.elements.emptyTile.top))===Math.floor(this.parameters.tileSize)&&(this.elements.tiles[t].left=this.elements.emptyTile.left,this.elements.tiles[t].style.left=`${this.elements.emptyTile.left}px`,this.elements.tiles[t].top=this.elements.emptyTile.top,this.elements.tiles[t].style.top=`${this.elements.emptyTile.top}px`,this.elements.tiles[t].position=this.elements.emptyTile.position,this.elements.emptyTile.left=s,this.elements.emptyTile.top=i,this.elements.emptyTile.position=l,this.counter.moves+=1,this.elements.counter.moves.textContent=this.counter.moves,(this.parameters.isNewGame||this.parameters.retoredGame)&&(this.startTimer(),this.parameters.isNewGame=!1),this.checkWin(),this.playSound(),this.saveGame())}getTileNumByPosition(e){let t=0;return this.elements.tiles.forEach(((s,i)=>{+s.position===e&&(t=i)})),t}saveGame(){null==localStorage.puzzle&&(localStorage.setItem("puzzleSize",""),localStorage.setItem("puzzle",""),localStorage.setItem("emptyTile",""),localStorage.setItem("moves",""),localStorage.setItem("time",""),localStorage.setItem("picture","")),localStorage.puzzleSize=this.parameters.puzzleSize,localStorage.puzzle=JSON.stringify(this.elements.tiles),localStorage.emptyTile=JSON.stringify(this.elements.emptyTile),localStorage.moves=this.counter.moves,this.picture.isPicture&&(localStorage.picture=this.picture.link)}getSavedGame(){this.parameters.puzzleSize=localStorage.puzzleSize,this.elements.savedTiles=JSON.parse(localStorage.puzzle),this.elements.savedEmptyTile=JSON.parse(localStorage.emptyTile),this.counter.moves=+localStorage.moves,this.counter.time=localStorage.time,""!==localStorage.picture&&(this.picture.link=localStorage.picture,this.picture.isPicture=!0,localStorage.picture=""),this.parameters.isNewGame=!1,this.parameters.retoredGame=!0}dragStart(e){const{key:t}=e.target;Math.abs(this.elements.tiles[t].left-this.elements.emptyTile.left)+Math.abs(this.elements.tiles[t].top-this.elements.emptyTile.top)===this.parameters.tileSize&&(this.parameters.drag.X=e.clientX,this.parameters.drag.Y=e.clientY,setTimeout((()=>{this.elements.tiles[t].classList.add("hide")}),0))}dragEnd(e){const t=Math.abs(this.parameters.drag.X-e.clientX),s=Math.abs(this.parameters.drag.Y-e.clientY);this.parameters.drag.X=null,this.parameters.drag.Y=null,(t>this.parameters.tileSize/4||s>this.parameters.tileSize/4)&&this.moveTile(e.target.key),this.elements.tiles[e.target.key].classList.remove("hide")}checkWin(){this.elements.tiles.every((e=>+e.innerHTML===e.position))&&(this.stopTimer(),this.createWinMessage(),this.showModal(),this.parameters.isEndGame=!0,this.saveResult(),this.picture.isPicture&&(this.elements.puzzle.style.background=`url("${this.picture.link}")`,this.elements.puzzle.style.backgroundSize="100%"))}createWinMessage(){const e=document.createElement("p"),t=document.createElement("p");var s;e.textContent="Ура! Вы решили головоломку",t.textContent=`за ${this.elements.counter.timer.innerHTML} и ${this.counter.moves} ход${s=this.counter.moves,s%10==1?"":s%10>1&&s%10<5?"a":"ов"}`,this.elements.modal.text.innerHTML="",this.elements.modal.text.append(e),this.elements.modal.text.append(t)}saveResult(){null==localStorage.bestResult&&localStorage.setItem("bestResult","");const e=new Date;this.results.date=`${e.getDate()}.${e.getMonth()+1}.${e.getFullYear()}`,this.results.puzzleSize=`${this.parameters.puzzleSize} x ${this.parameters.puzzleSize}`,this.results.moves=this.counter.moves,this.results.time=this.elements.counter.timer.innerHTML;let t=[];if(""!==localStorage.bestResult){t=JSON.parse(localStorage.bestResult);for(let e=0;e<t.length;e+=1)if(this.results.moves<t[e].moves){t.splice(e,0,this.results);break}this.results.moves>t[t.length-1].moves&&t.push(this.results),t.length>10&&(t.length=10),localStorage.bestResult=JSON.stringify(t)}else t.push(this.results),localStorage.bestResult=JSON.stringify(t)}createArr(){const e=this.parameters.puzzleSize;let t=[];for(let s=0;s<e**2;s+=1)t.push(s);for(t=l(t);!n(t,e);)t=l(t);return t}createCounter(){const{counter:e}=this.elements;if(e.counter=document.createElement("div"),e.counter.classList.add("counter"),e.moves=document.createElement("div"),e.moves.classList.add("moves"),e.moves.textContent=this.counter.moves,e.timer=document.createElement("div"),e.timer.classList.add("timer"),localStorage.time){const{time:t}=localStorage,s=t%60,i=Math.floor(t/60)%3600;e.timer.textContent=`${a(i)}:${a(s)}`}else e.timer.textContent="00:00";e.counter.append(e.moves),e.counter.append(e.timer),this.elements.main.append(e.counter)}createMenu(){const{menu:e}=this.elements;e.menu=document.createElement("div"),e.menu.classList.add("menu"),e.newGame=document.createElement("button"),e.newGame.classList.add("button"),e.newGame.textContent="Начать новый пазл",e.newGame.addEventListener("click",(()=>{this.newGame()})),e.newGamePic=document.createElement("button"),e.newGamePic.classList.add("button"),e.newGamePic.textContent="Новый пазл с картинкой",e.newGamePic.addEventListener("click",(()=>{this.newGame(),this.picture.isPicture=!0,this.addPicture()})),e.newGameSize=document.createElement("select"),e.newGameSize.setAttribute("name","select"),e.newGameSize.classList.add("input");for(let t=3;t<9;t+=1){const s=document.createElement("option");s.setAttribute("value",t),4===t&&s.setAttribute("selected","selected"),s.textContent=`Размер поля ${t}х${t}`,e.newGameSize.append(s)}e.table=document.createElement("button"),e.table.classList.add("button"),e.table.textContent="Таблица лучших результатов",e.table.addEventListener("click",(()=>{this.createResultTable(),this.showTable()})),e.finish=document.createElement("button"),e.finish.classList.add("button"),e.finish.textContent="Завершить автоматически (3x3)",e.finish.addEventListener("click",(()=>{this.autoResolve()})),e.volume=document.createElement("button"),e.volume.setAttribute("type","button"),e.volume.classList.add("volume"),e.volume.innerHTML='<i class="material-icons">volume_off</i>',e.volume.addEventListener("click",(()=>{this.handleVolumeButtonClick()})),this.elements.audio=document.createElement("audio"),this.elements.audio.setAttribute("src","assets/tink.wav"),e.hideDig=document.createElement("button"),e.hideDig.setAttribute("type","button"),e.hideDig.classList.add("volume"),e.hideDig.innerHTML='<i class="material-icons">visibility</i>',e.hideDig.addEventListener("click",(()=>{this.handleDigitsView()}));const t=document.createElement("div");t.classList.add("settings"),t.append(e.hideDig),t.append(e.volume),e.menu.append(e.newGame),e.menu.append(e.newGamePic),e.menu.append(e.newGameSize),e.menu.append(e.table),e.menu.append(e.finish),e.menu.append(t),e.menu.append(this.elements.audio),this.elements.main.append(e.menu)}playSound(){if(this.parameters.volume){const e=document.querySelector("audio");e.currentTime=0,e.play()}}autoResolve(){if(3===this.parameters.puzzleSize){const i=function(i){const l=[],n=function(i){const l=[],n=[];n.push(-1),n.push(-1),n.push(i),n.push(0),n.push(e(i)),n.push(e(i)),l.push(n);let a=0,o=0,r=0;for(a=1;a<2e4;a+=1){const i=t(l[l.length-1][2]);i.forEach((t=>{t.push(a),o=e(t[2]),t.push(o),r=a+o,t.push(r)})),i.forEach(((e,t)=>{e[1]===l[l.length-1][0]&&i.splice(t,1)})),i.forEach(((e,t)=>{l.forEach((l=>{s(e[2],l[2])&&i.length>1&&i.splice(t,1)}))}));let[...n]=[...i[0]];i.forEach((e=>{e[5]<n[5]&&([...n]=[...e])}));const m=[];if(i.forEach(((e,t)=>{i.forEach(((s,i)=>{t!==i&&e[5]===s[5]&&e[5]<=n[5]&&(m.includes(e)||m.push(e))}))})),0===m.length)l.push(n);else{const s=[];m.forEach((i=>{const l=t(i[2]);l.forEach((t=>{t.push(a+1),o=e(t[2]),t.push(o),t.push(a+o+1)})),s.push(l)}));const i=s[0][0][5];let r=0;s.forEach((e=>{e.forEach((e=>{e[5]<i&&([r]=e)}))})),m.forEach((e=>{e[1]===r&&(n=e)})),l.push(n)}if(0===e(n[2])){l.push(n);break}}return l}(i);for(let e=1;e<n.length-1;e+=1)l.push(n[e][1]);return l}(this.elements.randomArray);if(confirm(`Решение займет ${i.length} ходов, ${i.length/100} секунд. Согласны ?`))for(let e=0;e<i.length;e+=1)setTimeout((()=>{const t=this.getTileNumByPosition(i[e]+1);this.moveTile(t)}),20+10*e)}}handleVolumeButtonClick(){this.parameters.volume=!this.parameters.volume,this.parameters.volume?this.elements.menu.volume.innerHTML='<i class="material-icons">volume_up</i>':this.elements.menu.volume.innerHTML='<i class="material-icons">volume_off</i>'}handleDigitsView(){this.picture.isPicture&&(this.picture.digits=!this.picture.digits,this.elements.tiles.forEach((e=>{e.classList.toggle("hideDigits")})),this.picture.digits?this.elements.menu.hideDig.innerHTML='<i class="material-icons">visibility</i>':this.elements.menu.hideDig.innerHTML='<i class="material-icons">visibility_off</i>')}createModal(){const e=document.querySelector(".body"),{modal:t}=this.elements;t.modal=document.createElement("div"),t.modal.classList.add("modal"),t.text=document.createElement("div"),t.text.classList.add("modaltext");const s=document.createElement("div");s.classList.add("btns"),t.ok=document.createElement("button"),t.ok.classList.add("modalbutton"),t.ok.textContent="Ok",t.ok.addEventListener("click",(()=>{this.hideModal()})),t.newGame=document.createElement("button"),t.newGame.classList.add("modalbutton"),t.newGame.textContent="Начать новый пазл",t.newGame.addEventListener("click",(()=>{this.hideModal(),this.newGame()})),s.append(t.ok),s.append(t.newGame),t.modal.append(t.text),t.modal.append(s),e.append(t.modal)}showModal(){this.elements.modal.modal.classList.toggle("modal-active")}hideModal(){this.elements.modal.modal.classList.toggle("modal-active")}createTable(){const e=document.querySelector(".body"),{table:t}=this.elements;t.modal=document.createElement("div"),t.modal.classList.add("table"),t.table=document.createElement("table"),t.table.classList.add("table-item"),t.ok=document.createElement("button"),t.ok.classList.add("modalbutton"),t.ok.textContent="Ok",t.ok.addEventListener("click",(()=>{this.hideTable()})),t.modal.append(t.table),t.modal.append(t.ok),e.append(t.modal)}createResultTable(){let e;const{table:t}=this.elements;if(localStorage.bestResult){e=JSON.parse(localStorage.bestResult);const s=document.createElement("thead"),i=document.createElement("th"),l=document.createElement("th"),n=document.createElement("th"),a=document.createElement("th");i.textContent="Дата",l.textContent="Поле",n.textContent="Время",a.textContent="Ходов",s.append(i),s.append(l),s.append(n),s.append(a),t.table.append(s),e.forEach((e=>{const s=t.table.insertRow(-1),i=s.insertCell(0),l=s.insertCell(1),n=s.insertCell(2),a=s.insertCell(3);i.textContent=e.date,l.textContent=e.puzzleSize,n.textContent=e.time,a.textContent=e.moves}))}else t.table.innerHTML="Результатов еще нет"}showTable(){this.elements.table.modal.classList.toggle("table-active")}hideTable(){this.elements.table.modal.classList.toggle("table-active"),this.elements.table.table.innerHTML=""}newGame(){this.parameters.isNewGame=!0,this.parameters.puzzleSize=+this.elements.menu.newGameSize.value,this.stopTimer(),this.elements.tiles=[],this.elements.puzzle.innerHTML="",this.counter.moves=0,this.elements.counter.moves.textContent=0,this.counter.time=0,this.elements.counter.timer.textContent="00:00",this.counter.startTime=null,this.counter.endTime=null,this.elements.puzzle.classList.add("newpzl"),clearTimeout(this.counter.timeoutID),this.createTiles(),this.placeTiles(),setTimeout((()=>{this.elements.puzzle.classList.remove("newpzl")}),1100),localStorage.time=0,localStorage.moves=0,this.picture.isPicture&&(this.picture.isPicture=!1,this.elements.puzzle.style.background=""),this.saveGame()}startTimer(){null==this.counter.startTime&&null!=this.counter.time&&0!==this.counter.time?this.counter.startTime=Date.now()-this.counter.time*i:null==this.counter.startTime&&(this.counter.startTime=Date.now());const e=Math.floor((Date.now()-this.counter.startTime)/i);localStorage.time=e;const t=e%60,s=Math.floor(e/60)%3600;this.elements.counter.timer.textContent=`${a(s)}:${a(t)}`,null==this.counter.endTime&&(this.counter.timeoutID=setTimeout((()=>{this.startTimer()}),i))}stopTimer(){this.counter.endTime=Date.now()}}).init()})();